var ref$,w,h,patw,path,of1x,of1y,dpw,dph,x$,touchflag,audioinit,touch;function import$(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}w=(ref$=[1170,658])[0],h=ref$[1],patw=(ref$=[193,278])[0],path=ref$[1],of1x=(ref$=[298,273])[0],of1y=ref$[1],dpw=(ref$=[59,20])[0],dph=ref$[1],(x$=angular.module("ERGame",[])).config(["$compileProvider"].concat(function(t){return t.imgSrcSanitizationWhitelist(/^\s*(blob):|http:\/\/localhost:9998\/|http:\/\/0media.tw\/|http:\/\/reporter.tw\//)})),x$.controller("ERGame",["$scope","$interval","$timeout","$http","$sce"].concat(function(m,a,y,t,h){for(var n,i,r,o,d,e,s,u,c,l,p,f=[],g=0;g<12;++g)n=g,f.push([n%4,parseInt(n/4)]);return m.list=f,m.danger=!1,m.pixel={scene:{w:1170,h:658},sprite:{size:[{w:0,h:0},{w:101,h:142},{w:108,h:229},{w:108,h:229},{w:291,h:245},{w:316,h:269},{w:105,h:196},{w:146,h:239},{w:98,h:60},{w:306,h:298},{w:191,h:240},{w:104,h:136},{w:238,h:184}],points:[{x:591,y:-19,type:6}].concat([{x:317,y:2,type:5}],[{x:687,y:-36,type:7}],[{x:507,y:54,type:9,variant:1}],[{x:249,y:184,type:11}],function(){for(var t,e=[],n=0;n<3;++n)for(i=n,t=0;t<4;++t)r=t,e.push({x:293+59*r+-127*i,y:222+20*r+47*i,type:1,variant:0,active:1});return e}(),[{x:857,y:100,type:4,variant:0,active:1}],[{x:870,y:272,type:12}],function(){for(var t=[],e=0;e<5;++e)n=e,t.push({x:749+66*n,y:227+24*n,type:2,variant:0,active:1});return t}(),[{x:623,y:279,type:3,variant:0,active:1},{x:520,y:341,type:10},{x:730,y:387,type:4,variant:0,active:1},{x:335,y:387,type:4,variant:0,active:1},{x:493,y:418,type:3,variant:0,active:1},{x:678,y:418,type:2,variant:0,active:1}])}},m.percent={sprite:{size:function(){for(var t,e=[],n=0,i=(t=m.pixel.sprite.size).length;n<i;++n)o=t[n],e.push({w:100*o.w/m.pixel.scene.w,h:100*o.h/m.pixel.scene.h});return e}(),points:function(){for(var t,e=[],n=0,i=(t=m.pixel.sprite.points).length;n<i;++n)o=t[n],e.push({x:100*o.x/m.pixel.scene.w,y:100*o.y/m.pixel.scene.h,type:o.type,variant:o.variant,active:o.active});return e}()}},m.rebuild=function(t){for(var e,n=[],i=0,r=(e=m.percent.sprite.points).length;i<r;++i)t=e[i],n.push(t.cls=["it-"+t.type+"-"+(t.variant||0)+"-"+(t.active||0)]);return n},m.game={state:0,over:function(){return this.setState(4),y(function(){var t=parseInt(m.doctor.score.value/10);return 6<=t&&t--,m.doctor.rank=t=6<=t?6:t,m.share.updateRank()},500)},setState:function(t){return this.state=t},tutorial:function(){return this.setState(3),m.audio.bkloop(0,!0,!0),m.audio.bk.pause(!0)},lastState:0,pause:function(){if(!(this.state<=1))return m.audio.bk.pause(),m.audio.bkloop.pause(),this.lastState=this.state,this.setState(1)},resume:function(){if(this.setState(this.lastState||2),2===this.lastState&&m.audio.bk(),3===this.lastState)return m.audio.bkloop()},start:function(){return this.setState(2),m.audio.bkloop.pause(!0),m.audio.bk()},reset:function(){return $("#wheel").css({display:"none"}),m.danger=!1,m.patient.reset(),m.doctor.reset(),m.supply.reset(),m.mouse.reset(),m.audio.reset(),m.dialog.reset(),m.rebuild(),m.madmax=0,m.dialog.toggle(null,!1),this.state=0},countdown:{handler:null,value:0,count:function(){var t=this;return this.value=this.value-1,0<this.value?(m.audio["count"+(1===this.value?2:1)](),y(function(){return t.count()},650)):(m.game.setState(2),m.audio.bkloop.pause(!0),m.audio.bk(0,!1,!0))},start:function(){return m.game.setState(5),this.value=5,this.count()}}},m.doctor={sprite:m.percent.sprite.points.filter(function(t){return 9===t.type})[0],handler:null,energy:1,faint:!1,demading:0,chance:5,hurting:0,draining:0,rank:0,drain:function(){var t=this;if(t.energy-=.2,0<=t.energy||(t.energy=0),t.draining=1,m.doctor.energy<=1e-4)return m.doctor.faint=!0,m.doctor.demading=0},fail:function(){var t=this;return t.setMood(7),--t.chance,0<=t.chance||(t.chance=0),t.hurting=1,this.chance<=0&&m.game.over(),m.audio.die()},reset:function(){return this.rank=0,this.energy=1,this.faint=!1,this.chance=5,this.hurting=0,this.draining=0,this.handler&&y.cancel(this.handler),this.score.value=0,this.score.digit=[0,0,0,0],this.setMood(1)},score:{digit:[0,0,0,0],value:0},resetLater:function(){var t=this;return this.handler&&y.cancel(this.handler),this.handler=y(function(){return t.setMood(1),t.handler=null,m.rebuild()},1e3)},setMood:function(t){if(1<(this.sprite.variant=t))return this.resetLater()}},m.$watch("doctor.score.value",function(){for(var t,e=[],n=m.doctor.score,i=0;i<4;++i)t=i,e.push(n.digit[3-t]=parseInt(n.value/Math.pow(10,t))%Math.pow(10,t+1));return e}),m.supply={sprite:m.percent.sprite.points.filter(function(t){return 5===(t=t.type)||6===t||7===t}),reset:function(){for(var t,e,n=[],i=0,r=(t=this.sprite).length;i<r;++i)e=t[i],n.push((e.active=0,e.countdown=-1,e));return n},active:function(t,e){return null==e&&(e=!0),t=null==t?parseInt(Math.random()*this.sprite.length):t,e?this.sprite[t].active?void 0:(this.sprite[t].active=1,this.sprite[t].countdown=1):(this.sprite[t].active=0,t=(e=this.sprite[t]).countdown,delete e.countdown,t)}},m.patient={urgent:0,updateUrgent:function(){return this.urgent=m.percent.sprite.points.filter(function(t){return 1===t.type&&3===t.variant}).length},reset:function(){for(var t,e=m.percent.sprite.points.filter(function(t){return 1<=t.type&&t.type<=4}),n=0,i=e.length;n<i;++n)(t=e[n]).variant=0,t.mad=0,t.life=1;return this.urgent=0},add:function(e,t,n){var i,r,a=m.percent.sprite.points.filter(function(t){return t.type===e&&0===t.variant});if(0!==a.length)return i=parseInt(3*Math.random()+1),1===e?(i=(r=Math.random())<m.config.cur.prob.pat[1]?1:r<m.config.cur.prob.pat[2]?2:3,m.audio.born()):i=parseInt(2*Math.random()+1),1<e&&(i<=2||(i=2)),null!=t&&(i=t),(r=a[null!=n?n:parseInt(Math.random()*a.length)]).variant=i,1===r.type&&3===r.variant&&this.urgent++,1===r.type&&(r.life=1),2!==(t=r.type)&&3!==t&&4!==t||(r.mad=0),m.rebuild()}},m.mode="easy",m.config={cur:{prob:{pat:[.05,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.001,mad:.001}},mode:{trivial:[{prob:{pat:[0,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.001,mad:.001}},{prob:{pat:[0,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.001,mad:.001}},{prob:{pat:[0,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.001,mad:.001}},{prob:{pat:[0,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.001,mad:.001}}],easy:[{prob:{pat:[.02,.6,.95],sup:.01,stay:.1},decay:{life:.001,sup:.005,mad:.001}},{prob:{pat:[.04,.5,.82],sup:.02,stay:.2},decay:{life:.002,sup:.008,mad:.002}},{prob:{pat:[.08,.4,.7],sup:.04,stay:.4},decay:{life:.003,sup:.011,mad:.003}},{prob:{pat:[.12,.3,.6],sup:.1,stay:.5},decay:{life:.006,sup:.014,mad:.006}}],normal:[{prob:{pat:[.02,.45,.95],sup:.01,stay:.1},decay:{life:.002,sup:.005,mad:.001}},{prob:{pat:[.06,.4,.8],sup:.03,stay:.3},decay:{life:.003,sup:.015,mad:.003}},{prob:{pat:[.14,.3,.5],sup:.09,stay:.5},decay:{life:.005,sup:.02,mad:.005}},{prob:{pat:[.22,.1,.2],sup:.15,stay:.6},decay:{life:.006,sup:.025,mad:.007}}],hard:[{prob:{pat:[.02,.1,.95],sup:.25,stay:.6},decay:{life:.006,sup:.025,mad:.007}},{prob:{pat:[.02,.1,.95],sup:.25,stay:.6},decay:{life:.006,sup:.025,mad:.007}},{prob:{pat:[.02,.1,.95],sup:.25,stay:.6},decay:{life:.006,sup:.025,mad:.007}},{prob:{pat:[.02,.1,.95],sup:.25,stay:.6},decay:{life:.006,sup:.025,mad:.007}}]}},m.mouse={x:0,y:0,target:null,reset:function(){return this.target=null},lock:function(){return this.isLocked=!0},unlock:function(){return this.isLocked=!1},timestamp:0,isPalOn:!1,down:function(t,e){var n,i,r,a,o,s,u,c;if(null==e&&(e=!1),(!touchflag||e)&&!d()){if(m.madmax||m.doctor.faint)return m.demad(t);if(!this.isLocked&&!this.isPalOn&&(m.dialog.finger.isOn=!1,e=$("#wrapper").offset(),n=(r=[t.clientX||t.pageX,t.clientY||t.pageY])[0],i=r[1],n||i||(n=(r=[t.touches[0].clientX,t.touches[0].clientY])[0],i=r[1]),(r=this.last||(this.last={})).x=n,r.y=i,r=[n-e.left,i-e.top],this.x=r[0],this.y=r[1],n=r[0],i=r[1],e=1024*n/$("#wrapper").width(),r=576*i/$("#wrapper").height(),e=m.hitmask.resolve(e,r))){if(1===e.type){if(0===e.variant)return;for(s=o=0,u=(a=m.percent.sprite.points.filter(function(t){return 1===t.type})).length;s<u;++s)(c=a[s]).variant>o&&(o=c.variant);if(3===o&&e.variant<o)return void(this.target=null)}if((this.target=e)&&1===e.type)return $("#wheel").css({display:"block",top:i+"px",left:n+"px"}),m.audio.blop(),m.rebuild(),this.timestamp=(new Date).getTime(),this.isPalOn=!0,t.preventDefault()}}},move:function(t){},up:function(t,e){var n,r,a,o=this;if(null==e&&(e=!1),(!touchflag||e)&&!d()&&!(this.isLocked||m.madmax||m.doctor.faint||(e=(new Date).getTime(),n=[t.clientX||t.pageX,t.clientY||t.pageY],r=n[0],a=n[1],r||a||(null!=t.touches&&t.touches.length?(n=[t.touches[0].clientX,t.touches[0].clientY],r=n[0],a=n[1]):null!=t.changedTouches&&t.changedTouches.length&&(n=[t.changedTouches[0].clientX,t.changedTouches[0].clientY],r=n[0],a=n[1])),r||a||(n=[this.last.x,this.last.y],r=n[0],a=n[1]),this.target&&1===this.target.type&&(Math.pow(r-this.last.x,2)+Math.pow(a-this.last.y,2)<72||e-this.timestamp<100))))return setTimeout(function(){var t,e,n,i;return o.isPalOn=!1,$("#wheel").css({display:"none"}),t=$("#wrapper").offset(),e=(t=[r-o.x-t.left,a-o.y-t.top])[0],i=t[1],e=360*Math.acos(e/Math.sqrt(Math.pow(e,2)+Math.pow(i,2)))/(2*Math.PI),(320<=(e=0<i?360-e:e)||e<=10)&&(n=3),10<e&&e<=61&&(n=2),61<e&&e<112&&(n=1),o.target&&(1===o.target.type?(o.target.variant===n?(1===o.target.variant?(i=Math.random()<.5?2:4+parseInt(3*Math.random()),null!=o.forceMood&&(i=o.forceMood),m.doctor.setMood(i),m.audio.dindon(),2===i&&(m.doctor.score.value+=1)):(null==o.forceStay&&Math.random()<m.config.cur.prob.stay?(m.doctor.setMood(3),m.patient.add(parseInt(3*Math.random()+2))):o.forceStay?(m.doctor.setMood(3),m.patient.add(o.forceStayType||4,2,o.forceStayPos||0)):m.doctor.setMood(2),m.audio.dindon(),m.doctor.score.value+=1),3===n&&(o.target.variant=0)):m.doctor.fail(),3===n&&m.patient.updateUrgent(),o.target.variant=0,m.rebuild()):2<=o.target.type&&o.target.type<=4&&o.target.variant?(.8<o.target.mad&&(o.target.mad=.8),(t=o.target).mad<=.8||(t.mad=.8),o.target.mad-=.2,0<=(t=o.target).mad||(t.mad=0),m.audio.click2()):5<=o.target.type&&o.target.type<=8&&o.target.active&&(m.doctor.energy+=.1,(t=m.doctor).energy<=1||(t.energy=1),m.doctor.setMood(2),m.rebuild(),o.target.active=0,o.target.countdown=1,m.audio.click2())),o.target=null},0)}},m.madmax=0,m.demad=function(t){var e,n,i;return m.dialog.finger.isOn=!1,e=100,(n=m.percent.sprite.points.filter(function(t){return t.ismad})).length||(m.madmax=0),n.length?((i=n[0]).mad<=.8||(i.mad=.8),n[0].mad-=.1,0<=(i=n[0]).mad||(i.mad=0),n[0].mad<=0&&delete n[0].ismad,e=100*n.map(function(t){return 1-t.mad}).reduce(function(t,e){return t+e},0)/n.length):m.doctor.faint&&((i=m.doctor).energy+=.1,i.energy<=1||(i.energy=1),.9999<=m.doctor.energy&&(m.doctor.faint=!1),e=100*m.doctor.energy),t.preventDefault(),m.audio.click2(),m.doctor.demading=e,!1},m.rebuild(),d=function(){return 2!==m.game.state&&3!==m.game.state||!0===m.dialog.show||!!m.danger},m.madspeed=.002,m.$watch("madmax",function(t){if(t)return $("#wheel").css({display:"none"})}),m.hitmask={ready:!1,get:function(t,e){return!this.ready||null==t||null==e||isNaN(t)||isNaN(e)?[0,0,0,0]:this.ctx.getImageData(t,e,1,1).data},resolve:function(t,e){var t=this.get(t,e),n=t[0];return 0===(n=8===n?5:n)?null:(e=1===n?4*t[1]+t[2]:t[2],m.percent.sprite.points.filter(function(t){return t.type===n})[e])},init:function(){var t=this,e=this.canvas=document.createElement("canvas");return e.height=576,e.width=1024,this.ctx=this.canvas.getContext("2d"),this.img=new Image,this.img.src="assets/img/mask.png",this.img.onload=function(){return t.ctx.drawImage(t.img,0,0,1024,576),t.ready=!0}}},m.hitmask.init(),m.dialog={tut:!0,show:!1,idx:0,next:function(){var t=this;return y(function(){return t.main(!0)},200)},type:"",h:{i:[],t:[]},finger:{value:1,isOn:!1},reset:function(){var t,e,n,i,r=[];for(this.tut=!0,this.show=!1,this.idx=0,this.type="",this.finger={value:1,isOn:!1},t=0,n=(e=this.step).length;t<n;++t)(i=e[t]).fired=!1,i.reset&&r.push(i.reset());return r},skip:function(t){var e,n,i,r;for(null==t&&(t=!1),$("#finger-slide").css({display:"none"}),$("#finger-tap").css({display:"none"}),e=0,i=(n=this.h.i).length;e<i;++e)r=n[e],a.cancel(r);for(e=0,i=(n=this.h.t).length;e<i;++e)r=n[e],y.cancel(r);return t||this.clean(),this.idx===this.step.length-2?this.next():(this.type="",t?(this.idx=this.step.length-2,this.toggle(0,!0)):void 0)},interval:function(t,e){t=a(t,e);return this.h.i.push(t),t},timeout:function(t,e){t=y(t,e);return this.h.t.push(t),t},clean:function(){var t;return delete m.mouse.forceStay,delete m.mouse.forceMood,m.game.reset(),(t=m.dialog).tut=!1,t.idx=this.step.length-1,m.mouse.unlock(),$("#score").removeClass("hint"),(t=m.doctor).chance=5,t.hurting=0,t.faint=!1,t.energy=1,t.setMood(2),m.game.setState(2),m.game.countdown.start()},step:[{},{ready:!1,reset:function(){return this.ready=!1},check:function(){return this.ready||3!==m.game.state||(this.ready=!0),this.ready},fire:function(){return m.mouse.forceStay=!1,m.mouse.forceMood=1,m.mouse.lock(),m.dialog.timeout(function(){return m.patient.add(1,1,0)},800),m.dialog.timeout(function(){return m.patient.add(1,2,0)},1600),m.dialog.timeout(function(){return m.patient.add(1,3,0)},2400)}},{ready:!1,reset:function(){return this.ready=!1},check:function(){var t=this;return!!this.ready||(0<m.percent.sprite.points.filter(function(t){return 1===t.type&&3===t.variant}).length&&m.dialog.timeout(function(){return t.ready=!0},1e3),!1)}},{check:function(){return!0}},{check:function(){return!0},fire:function(){return $("#finger-slide").css({display:"block",top:"33%",left:"22%"}),setTimeout(function(){return $("#finger-slide").css({display:"none"}),m.mouse.unlock()},3e3)}},{reset:function(){return this.handler=null,this},check:function(){var t,e=this;return m.doctor.chance<5&&($("#oops").css({display:"block"}),m.doctor.chance=5,m.patient.reset(),m.patient.add(1,1,0),m.patient.add(1,2,0),m.patient.add(1,3,0),setTimeout(function(){return $("#oops").css({display:"none"})},1e3)),(t=0===m.percent.sprite.points.filter(function(t){return 1===t.type&&0!==t.variant}).length)&&5===m.doctor.chance&&(m.dialog.type="mini",this.handler=m.dialog.timeout(function(){return m.doctor.hurting=1,e.handler=null},500)),t},fire:function(){var t=m.doctor;if(t.chance=5,t.hurting=0,this.handler)return y.cancel(this.handler)}},{check:function(){return $("#score").addClass("hint"),!0},fire:function(){return $("#score").removeClass("hint")}},{mood:0,reset:function(){return this.handler=null,this.mood=0,this},check:function(){var t=this;return null==this.handler&&(this.handler=m.dialog.interval(function(){return m.doctor.setMood(t.mood+4),m.rebuild(),t.mood=(t.mood+1)%3},500)),!0},fire:function(){return m.doctor.setMood(1),m.rebuild(),a.cancel(this.handler),m.mouse.forceStay=!0,m.patient.add(1,2,0)}},{mood:3,ready:!1,handler:null,moodHandler:null,reset:function(){return this.handler=null,this.moodHandler=null,this.ready=!1,this.mood=3,this},check:function(){var t,e,n=this;return m.doctor.chance<5&&($("#oops").css({display:"block"}),m.doctor.chance=5,m.patient.reset(),setTimeout(function(){return $("#oops").css({display:"none"})},800)),t=m.percent.sprite.points.filter(function(t){return(2===t.type||4===t.type)&&0<t.variant}).length,m.mouse.forceStayType=t?2:4,e=0<m.percent.sprite.points.filter(function(t){return 1===t.type&&2===t.variant}).length,1<t&&null==this.handler&&(this.handler=m.dialog.timeout(function(){return n.ready=!0},1e3)),t<2&&!e&&m.patient.add(1,2,parseInt(1+4*Math.random())),this.ready&&!this.moodHandler&&(this.moodHandler=m.dialog.interval(function(){return m.doctor.setMood(n.mood),m.rebuild(),n.mood=4-n.mood},500)),this.ready},fire:function(){var t;return a.cancel(this.moodHandler),(t=m.dialog.finger).isOn=!0,t.y=[344,266],t.x=[750,1e3],t.small=!0,m.madspeed=.015,m.dialog.timeout(function(){var t=m.dialog.finger;return t.isOn=!1,t.small=!1,t},2300)}},{ready:!1,handler:null,reset:function(){return this.handler=null,this.ready=!1,this},check:function(){var t=this;return.015!==m.madspeed||m.dialog.finger.isOn||this.handler||(this.handler=m.dialog.timeout(function(){return t.ready=!0},1e3)),this.ready},fire:function(){return m.madspeed=.04,m.mouse.lock()}},{ready:!1,reset:function(){return this.ready=!1},check:function(){return m.madmax&&(this.ready=!0),this.ready}},{launched:0,supply:0,ready:!1,reset:function(){return this.launched=0,this.supply=0,this.ready=!1,this.handler=null,this},check:function(){var t,e=this;return 1<=m.madmax&&0===this.launched&&(this.launched=1,(t=m.dialog.finger).isOn=!0,t.y=197.4,t.x=351,m.madspeed=.002),.002===m.madspeed&&m.madmax<1&&1===this.launched&&(this.launched=2,m.percent.sprite.points.filter(function(t){return 4===t.type})[0].mad=0,m.dialog.timeout(function(){return e.handler=m.dialog.interval(function(){return m.supply.active(e.supply,!1),e.supply=(e.supply+1)%3,m.supply.active(e.supply)},500),e.ready=!0},1e3)),this.ready},fire:function(){var t;return a.cancel(this.handler),m.supply.active(0,!1),m.supply.active(1,!0),m.supply.active(2,!1),(t=m.dialog.finger).isOn=!0,t.y=46.06,t.x=234,m.dialog.timeout(function(){return m.mouse.unlock()},1e3)}},{ready:!1,handler:!1,reset:function(){return this.handler=null,this.ready=!1,this},check:function(){var t=this;return this.handler||(this.handler=m.dialog.timeout(function(){return t.ready=!0,m.supply.active(1,!1),m.doctor.setMood(7),m.rebuild(),m.doctor.energy-=.1},3e3)),this.ready},fire:function(){}},{check:function(){return!0},fire:function(){var t;return m.doctor.energy=0,m.doctor.faint=!0,m.doctor.demading=0,(t=m.dialog.finger).isOn=!0,t.y=131.6,t.x=351,t}},{ready:!1,reset:function(){return this.ready=!1,this.handler=null,this},check:function(){var t=this;return null==this.handler&&.999<=m.doctor.energy&&!1===m.doctor.faint&&(this.handler=m.dialog.timeout(function(){return m.dialog.type="",t.ready=!0},1e3)),this.ready}},{check:function(){return!0},fire:function(){return m.dialog.clean()}},{check:function(){return!1}}],main:function(t){if((t=null==t?!1:t)&&this.step[this.idx]&&this.step[this.idx].fire&&!this.step[this.idx].fired&&(this.step[this.idx].fire(),this.step[this.idx].fired=!0),!this.show||t)return this.step[this.idx+1]&&this.step[this.idx+1].check()?this.toggle(this.idx+1,!0):this.toggle(0,!1)},toggle:function(t,e){var n=this;return t&&(this.idx=t),setTimeout(function(){return n.show=null==e?!n.show:e,n.show?($("#dialog").fadeIn(),m.audio.menu()):$("#dialog").fadeOut()},0)}},m.scream=gajus.Scream({width:{portrait:320,landscape:480}}),m.dimension={update:function(){var t=[$(window).width(),$(window).height()],e=t[0],n=t[1],i=(t=e<1024?[e,576*e/1024]:[1024,576])[0],r=t[1];if(t=n<576?[1024*n/576,n]:[1024,576],i=(t=n<r?[t[0],t[1]]:[i,r])[0],r=t[1],r*=.9,this.w=i*=.9,this.h=r,$("#frame").css({width:i+"px",height:r+"px"}),$("#container").css({width:i+"px"}),$("body").css({overflow:"hidden"}),e<n?(this.portrait=!0,2===m.game.state&&m.game.pause()):this.portrait=!1,this.portrait?($("#frame").css({padding:0,position:"absolute",top:0,left:0,height:"100%",width:"100%"}),$("#wrapper").css({width:"100%",height:"100%",top:"0",left:"0"})):n-r<=110?($("#frame").css({padding:"0",position:"fixed",top:(n-r)/2+"px",left:(e-i)/2+"px"}),$("#wrapper").css({width:i+"px",height:r+"px",top:"0",left:"0"}),$("#head").css({display:"none"}),$("#foot").css({display:"none"})):($("#frame").css({padding:"10px",position:"relative",top:"auto",left:"auto",height:10+r+"px"}),$("#wrapper").css({width:i-20+"px",height:r-10+"px",top:"10px",left:"10px"}),$("#head").css({display:"block"}),$("#foot").css({display:"block"})),$("#prehide").css("display","none"),m.canvas&&m.canvas.e)return m.canvas.update()},portrait:!1,rotate:function(){}},m.dimension.update(),window.onresize=function(){return m.$apply(function(){return m.dimension.update()})},document.ontouchmove=function(t){if(m.isPad||m.ismin)return t.preventDefault()},m.progress={value:0,latest:0,use:null,count:{total:0,current:0,update:function(){}},size:{total:0,current:0,group:{},update:function(t,e){var n,i,r,a;for(r in m.progress.setUse("size"),import$((n=this.group)[t]||(n[t]={}),e),i=[],n=this.group)a=n[r],i.push(a);return t=i,this.total=t.reduce(function(t,e){return t+e.total},0),this.current=t.reduce(function(t,e){return t+e.current},0)}},setUse:function(t){return this.use=this[t]},handler:null,transition:function(){var t,e,n=this;return 100<=this.value&&y(function(){return m.loading=!1},1e3),this.value>=this.latest?this.handler=null:(this.value=(t=this.value+3)<(e=this.latest)?t:e,this.handler=y(function(){return n.transition()},10))},update:function(){if(this.latest=parseInt(100*(this.count.current+this.size.current)/(this.count.total+this.size.total)),!this.handler)return this.transition()}},m.$watch("progress.count",function(){return m.progress.update()},!0),m.$watch("progress.size",function(){return m.progress.update()},!0),m.debug={d1:0,d2:0},e={spawn:function(){var t;if(!(m.dialog.tut||1!==(t=m.game.state)&&2!==t&&4!==t||(t=(new Date).getTime()/1e3-m.audio.bkt,m.config.cur=t<=60?m.config.mode[m.mode][0]:t<=98?m.config.mode[m.mode][1]:t<=120?m.config.mode[m.mode][2]:m.config.mode[m.mode][3],m.debug.d2=t,m.debug.d3=m.config.cur.prob.pat[2],98<=t&&t<=101&&2===m.game.state?m.danger=!0:t<=120&&(m.danger=!1),d())))return Math.random()<m.config.cur.prob.pat[0]&&m.patient.add(1),Math.random()<m.config.cur.prob.sup&&m.supply.active(),0===m.percent.sprite.points.filter(function(t){return 1===t.type&&0!==t.variant}).length&&.8<Math.random()&&m.patient.add(1),m.madspeed=m.config.cur.decay.mad},drain:function(t){var e,n,i,r,a,o,s=[];if(!d()){for(m.doctor.hurting&&(m.doctor.hurting-=.2,0<=(e=m.doctor).hurting||(e.hurting=0)),m.doctor.draining&&(m.doctor.draining-=.2,0<=(e=m.doctor).draining||(e.draining=0)),i=!1,r=0,a=(n=m.percent.sprite.points.filter(function(t){return 1===t.type&&0<t.variant})).length;r<a;++r)(t=n[r]).life-=m.config.cur.decay.life*t.variant,t.life<=0&&(t.life=0,m.doctor.fail(),i=!(t.variant=0));for(i&&m.patient.updateUrgent(),r=o=0,a=(n=m.percent.sprite.points.filter(function(t){var e;return(2===(e=t.type)||3===e||4===e)&&0<t.variant})).length;r<a;++r)null==(t=n[r]).mad&&(t.mad=0),t.mad+=m.madspeed,.8<=t.mad&&(t.mad=1,t.ismad=!0,o=1);if(o&&!m.madmax&&(m.madmax=parseInt(2*Math.random()+1),m.doctor.demading=0),!m.doctor.faint){for(r=0,a=(n=m.percent.sprite.points.filter(function(t){var e;return(5===(e=t.type)||6===e||7===e||8===e)&&t.active})).length;r<a;++r)(null==(t=n[r]).countdown||t.countdown<=0)&&(t.countdown=1),t.countdown-=m.config.cur.decay.sup,t.countdown<=0&&(t.countdown=1,t.active=0,s.push(m.doctor.drain()));return s}}},tweak:function(){var t,e,n=[$(window).width(),$(window).height()],i=n[0],r=n[1];3===m.game.state&&m.dialog.main(),t=!!/iPad/.exec(navigator.platform);try{e=m.scream.isMinimalView(),m.debug.d1=e}catch(t){}return!m.ismin||e||t||(document.body.scrollTop=0,$("#minimal-fix").css({display:"block"})),m.ismin=e,m.isPad=t,i===this.w&&r===this.h||m.dimension.update(),(n={w:this.w,h:this.h}).w=i,n.h=r,n}},a(function(){return e.spawn(),e.drain(),e.tweak()},100),m.loading=!0,m.$watch("loading",function(t){if(!t)return $("#loading").fadeOut()}),(s=document.body).ontouchstart=window.touch.down,s.ontouchmove=window.touch.move,s.ontouchend=window.touch.up,m.assets={fetch:function(o,s,u){var c,d=this,h=(new Date).getTime();return m.progress.count.total++,(c=new XMLHttpRequest).open("GET",o,!0),c.responseType="arraybuffer",c.onprogress=function(t){return m.$apply(function(){return m.progress.size.update(o,{current:t.loaded,total:t.total})})},c.onload=function(){return m.$apply(function(){for(var t,e=["",new Zlib.Gunzip(new Uint8Array(c.response)).decompress()],n=e[0],i=e[1],r=0,a=i.length;r<a;++r)t=r,n+=String.fromCharCode(i[t]);return e=d.parse(JSON.parse(n),s),u(e),e=(new Date).getTime(),m.progress.count.current++,console.log("[assets] Process "+o+" spent "+(e-h)+" ms.")})},c.send()},parse:function(t,e){var n,i,r,a,o,s,u,c,d={url:{},buf:{}};for(n in t){for(r=t[n],i=atob(r),r=new ArrayBuffer(i.length),a=new Uint8Array(r),o=0,s=i.length;o<s;++o)a[u=o]=i.charCodeAt(u);c=new Blob([a],{type:e}),d.buf[n]=r,d.url[n]=h.trustAsResourceUrl(URL.createObjectURL(c))}return d}},m.audio={s:{},buf:{},names:["click","count1","count2","blop","die","menu","dindon","born","click2","bkloop","bk","noop"],reset:function(){for(var t,e,n=0,i=(t=this.names).length;n<i;++n)this[t[n]].pause(!0);if(this.bkt=0,this.bk)return delete this.bk.pausetime,e=(t=this.bk).starttime,delete t.starttime,e},n:{},bkt:0,isMute:!1,toggleMute:function(){return this.isMute=!this.isMute,this.gain.gain.value=this.isMute?0:1},player:function(i){var r=this,a=function(t,e,n){if(null==e&&(e=!1),(n=null==n?!1:n)?delete a.pausetime:a.pausetime&&(t=a.pausetime-a.starttime,delete a.pausetime),a.starttime=parseInt((new Date).getTime()/1e3)-(null!=t?t:0),"bk"===i&&(r.bkt=a.starttime),r.buf[i])return r.n[i]&&r.n[i].disconnect(),r.n[i]=n=r.context.createBufferSource(),n.buffer=r.buf[i],n.connect(r.gain),e&&(n.loop=!0),null!=t?n.start(0,t):n.start(0)};return a.pause=function(t){if(null==t&&(t=!1),r.n[i])try{r.n[i].stop(0)}catch(t){0}if(!t)return a.pausetime=parseInt((new Date).getTime()/1e3)},a},init:function(){var t,e,n,i,r,u=this,a=window.AudioContext||window.webkitAudioContext;if(a=/Android.+Firefox.+/.exec(navigator.userAgent)?null:a)return m.progress.count.total+=this.names.length,this.context=new a,this.gain=this.context.createGain(),this.gain.connect(this.context.destination),m.assets.fetch("assets/snd/snd.gz","audio/mpeg",function(t){t.url;for(var e,n,i,r=t.buf,a=function(e,t){return u.context.decodeAudioData(r[t],function(t){return u.buf[e]=t},function(){return console.log("fail")})},o=0,s=(e=u.names.map(function(t){return[t,"snd/"+t+".mp3"]})).length;o<s;++o)n=(i=e[o])[0],i=i[1],u[n]=u.player(n),a(n,i);return m.progress.count.current+=u.names.length});for(t=function(n){var i=function(t,e){if(null==e&&(e=!1),i.pausetime&&(t=i.pausetime-i.starttime,delete i.pausetime),i.starttime=parseInt((new Date).getTime()/1e3)-(null!=t?t:0),"bk"===n)return u.bkt=i.starttime};return i.pause=function(t){if(!(t=null==t?!1:t))return i.pausetime=parseInt((new Date).getTime()/1e3)},i},e=0,i=(n=this.names).length;e<i;++e)this[r=n[e]]=t(r),this.s[r]={pause:o};function o(){}}},m.image={url:{},img:{},zoom:{},init:function(){var t,g=this;return m.progress.count.total++,m.progress.update(),t=/en/.exec(window.location.search||(navigator.languages||[])[0]||navigator.language||"en"),/zh/.exec(window.location.search)&&(t=!1),m.assets.fetch(t?"assets/img/img-en.gz":"assets/img/img-zh.gz","image/png",function(t){var e,n,i,r,a,o,s,u,c,d=t.url,h=(t.buf,[$("img.src"),$(".img-bk")]),l=h[0],p=h[1];for(e in g.url={},d)n=d[e],g.url["assets/"+e]=n;for(i=0,r=l.length;i<r;++i)a=i,s=(o=$(l[a])).attr("data-src"),null!=(u=g.url[s])&&o.attr("src",u.toString());for(i=0,r=p.length;i<r;++i)a=i,s=(o=$(p[a])).attr("data-src"),o.css({"background-image":"url("+g.url[s].toString()+")"});for(e in h=g.url)n=h[e],m.progress.count.total++,g.img[e]=c=new Image,c.src=n.toString(),c.onload=f;return y(function(){return m.progress.count.current++},100),m.$watch("loading",function(){return m.canvas.init()});function f(){return m.progress.count.current++}})}},m.audio.init(),m.image.init(),(u=[["hidden","visibilitychange"],["mozHidden","mozvisibilitychange"],["msHidden","msvisibilitychange"],["webkitHidden","webkitvisibilitychange"]].filter(function(t){return null!=document[t[0]]})[0])&&(document.addEventListener(u[1],function(){if(document[u[0]])return m.game.pause()},!1),document.addEventListener("pagehide",function(){return m.game.pause()},!1)),m.canvas={e:null,ctx:null,init:function(){var t=this;if(this.e=document.getElementById("main-canvas"),this.ctx=this.e.getContext("2d"),this.ctx.imageSmoothingEnabled=!0,this.ctx.mozImageSmoothingEnabled=!0,this.ctx.webkitImageSmoothingEnabled=!0,this.ctx.msImageSmoothingEnabled=!0,!m.usedom)return this.update(),this.handler?void 0:this.handler=a(function(){return t.draw()},100)},update:function(){var t,e,n;return this.e?(e=(t=[(t={w:(t=m.dimension).w,h:t.h}).w/100,t.h/100])[0],n=t[1],this.w!==e||this.h!==n?((t=this.e).width=1170,t.height=658,(t=this.e.style).width=100*e+"px",t.height=100*n+"px",this.w=e,this.h=n,this):void 0):this.init()},draw:function(t){var e,n,i,r,a,o,s,u,c,d,h,l,p,f=[];for(this.ctx.fillStyle="rgba(0,0,0,0.0)",this.ctx.fillRect(0,0,1170,658),e=m.image.img["assets/img/scenario.png"],this.ctx.drawImage(e,0,0,1170,658),n=0,r=(i=m.percent.sprite.points).length;n<r;++n)t=i[n],e=m.image.img["assets/img/it-"+t.type+"-"+(t.variant||0)+"-0.png"],a={w:11.7*(a=m.percent.sprite.size[t.type]).w,h:6.58*a.h,x:11.7*t.x,y:6.58*t.y},this.ctx.drawImage(e,a.x,a.y,a.w,a.h),t.active&&(e=m.image.img["assets/img/it-"+t.type+"-"+(t.variant||0)+"-1.png"],1===t.type?t.life<1&&this.ctx.drawImage(e,0,0,e.width,(1-t.life)*e.height,a.x,a.y,a.w,(1-t.life)*a.h):t.type<=4?0<t.mad&&this.ctx.drawImage(e,0,(1-t.mad)*e.height,e.width,t.mad*e.height,a.x,a.y+(1-t.mad)*a.h,a.w,t.mad*a.h):5<=t.type&&this.ctx.drawImage(e,0,0,e.width,e.height,a.x,a.y,a.w,a.h));if((m.doctor.faint||m.madmax||m.dialog.show&&!m.dialog.type||5===m.game.state)&&(this.ctx.fillStyle="rgba(65,65,65,0.7)",this.ctx.fillRect(0,0,1170,658)),m.patient.urgent&&(e=m.image.img["assets/img/urgency.png"],this.ctx.drawImage(e,0,0,1170,658)),(m.doctor.faint||m.madmax)&&(o=parseInt((new Date).getTime()/250)%2+1,c=(i=[.6*(1170-(s=(i=[11.7*35.5,11.7*35.5])[0])),.4*(658-(u=i[1]))])[0],d=i[1],e=m.doctor.faint&&!m.madmax?m.image.img["assets/img/mad/hungry"+o+".png"]:1===m.madmax?m.image.img["assets/img/mad/gangster"+o+".png"]:m.image.img["assets/img/mad/hysteria"+o+".png"],this.ctx.drawImage(e,c,d,s,u)),m.dialog.show&&(c=m.image.img["assets/img/tutorial/"+m.dialog.idx+".png"],d=m.image.img["assets/img/tutorial/doctor.png"],"mini"===m.dialog.type?this.ctx.drawImage(c,386.1,263.2,514.8,263.853):(this.ctx.drawImage(c,81.9,85.54,702,490.249),this.ctx.drawImage(d,819,111.86,234,433.45))),5===m.game.state&&(e=m.image.img["assets/img/countdown/"+(m.game.countdown.value-1||"go")+".png"],this.ctx.drawImage(e,409.5,148.5,351,351)),m.dialog.finger.isOn){if(o=parseInt((new Date).getTime()/100)%2+1,(h=m.dialog.finger).small){if(e=m.image.img["assets/img/mad/click-"+o+".png"],h.x.length){for(n=0,l=h.x.length;n<l;++n)p=n,f.push(this.ctx.drawImage(e,h.x[p],h.y[p],70.2,114.426));return f}return this.ctx.drawImage(e,h.x,h.y,70.2,114.426)}return e=m.image.img["assets/img/tutorial/finger"+o+".png"],this.ctx.drawImage(e,h.x,h.y,292.5,292.5)}}},m.usedom=!1,c={app_id:"2492205787583141",display:"popup",caption:"www.twreporter.org",picture:"http://0media.tw/p/ergame/assets/img/thumbnail.jpg",link:"http://0media.tw/p/ergame/",redirect_uri:"http://0media.tw/p/ergame/",description:"一款富含真實情境的經典急診室經營夢幻之作，為台灣第一個急診室新聞遊戲。遊戲背景鎖定在台灣的一間大型醫學中心，面對健保體制的崩壞、沒膽改革的政府以及愛跑大醫院看病的人民，擁有拯救急診室命運能力的鍵盤醫師，將在一次又一次的真實的醫療突發狀況中突圍，試圖拯救病患的生命。你，將在人類的極限體力、醫生的使命和病患的生命中作出抉擇，準備好了嗎？"},m.share={updateRank:function(){var n,i,t=m.doctor.score.value,r={app_id:"2492205787583141",display:"popup",caption:"急診人生 - 三分鐘的急診室醫師人生 / 報導者 x 0media",picture:"http://0media.tw/p/ergame/rank/s"+t+".png",link:"http://0media.tw/p/ergame/",name:"我在急診人生救了 "+t+" 個人，獲得「"+["見習醫生","實習醫生","住院醫生","總住院醫生","研究醫生","主治醫生","醫龍"][m.doctor.rank]+"」稱號！",redirect_uri:"http://0media.tw/p/ergame/",description:"一款富含真實情境的經典急診室經營夢幻之作，為台灣第一個急診室新聞遊戲。遊戲背景鎖定在台灣的一間大型醫學中心，面對健保體制的崩壞、沒膽改革的政府以及愛跑大醫院看病的人民，擁有拯救急診室命運能力的鍵盤醫師，將在一次又一次的真實的醫療突發狀況中突圍，試圖拯救病患的生命。你，將在人類的極限體力、醫生的使命和病患的生命中作出抉擇，準備好了嗎？"};return this.rank=function(){var t,e=[];for(n in t=r)i=t[n],e.push(n+"="+encodeURIComponent(i));return e}().join("&")},game:function(){var t,e=[];for(l in t=c)p=t[l],e.push(l+"="+encodeURIComponent(p));return e}().join("&"),link:encodeURIComponent("http://0media.tw/p/ergame/"),rank:""}})),window.ctrl={_s:null,scope:function(){var t;return(t=this._s)?t:this._s=angular.element("body").scope()},wrap:function(t,e){if(t||!touchflag)return this.scope().$apply(function(){return e()})},next:function(t){var e=this;return this.wrap(t=null==t?!1:t,function(){return e.scope().dialog.next(),e.scope().audio.click()})},skip:function(t,e,n){var i=this;return null==n&&(n=!0),this.wrap(t=null==t?!1:t,function(){return i.scope().dialog.skip(n),i.scope().audio.click(),e.preventDefault()})},pause:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().game.pause(),n.scope().audio.click(),e.preventDefault()})},mute:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().audio.toggleMute(),e.preventDefault(),e.cancelBubble=!0})},replay:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().game.reset(),n.scope().audio.click()})},resettutorial:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().game.reset(),n.scope().game.tutorial(),n.scope().audio.click()})},tutorial:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().game.tutorial(),n.scope().audio.click()})},cont:function(t,e){var n=this;return this.wrap(t=null==t?!1:t,function(){return n.scope().audio.click(),n.scope().game.resume()})},copy:function(){var t;return this.scope().audio.click(),(t=new Clipboard("#pause-link")).on("success",function(){}),t.on("error",function(){})}},audioinit=touchflag=!1,window.touch=touch={down:function(t){var e;if(touchflag=!0,angular.element("#wrapper").scope().mouse.down(t,!0),((e=angular.element("#wrapper").scope()).isMin||e.isPad)&&!(t.target&&"a"===t.target.nodeName.toLowerCase()||t.target.parentNode&&"a"===t.target.parentNode.toLowerCase()))return t.preventDefault()},up:function(t){var e;if(touchflag=!0,angular.element("#wrapper").scope().mouse.up(t,!0),!audioinit&&(e=angular.element("#wrapper").scope().audio.noop))return e()},move:function(t){return angular.element("#wrapper").scope().mouse.move(t,!0)}};