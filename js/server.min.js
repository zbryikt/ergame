var chokidar,http,fs,path,jade,stylus,uglify,lsc,cwd,cwdRe,pad,now,_log,ignoreList,ignoreFunc,typeTable,watchPath,mkdirRecurse,stylTree,ctype,ftype,sampleCgi,routeTable,server,log,filecache,updateFile,watcher,replace$="".replace;function in$(e,i){for(var a=-1,t=i.length>>>0;++a<t;)if(e===i[a])return!0;return!1}chokidar=require("chokidar"),http=require("http"),fs=require("fs"),path=require("path"),jade=require("jade"),stylus=require("stylus"),uglify=require("uglify-js"),lsc=require("LiveScript"),RegExp.escape=function(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},cwd=path.resolve(process.cwd()),cwdRe=new RegExp(RegExp.escape(cwd+""+("/"===cwd[cwd.length-1]?"":"/"))),pad=function(e){return(e+"").length<2?"0"+e:e+""},now=function(){return e=new Date,"["+pad(e.getMonth()+1)+"/"+pad(e.getDate())+" "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds())+"]";var e},_log=console.log,console.log=function(){for(var e,i=[],a=0,t=arguments.length;a<t;++a)i.push(arguments[a]);return e=i,_log.apply(null,[now()].concat(e))},ignoreList=[/^build-assets.ls$/,/^server.ls$/,/^library.jade$/,/^\.[^/]+/,/^node_modules\//,/^assets\//],typeTable={"3gp":"video/3gpp",aiff:"audio/x-aiff",arj:"application/x-arj-compressed",asf:"video/x-ms-asf",asx:"video/x-ms-asx",au:"audio/ulaw",avi:"video/x-msvideo",bcpio:"application/x-bcpio",ccad:"application/clariscad",cod:"application/vnd.rim.cod",com:"application/x-msdos-program",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",deb:"application/x-debian-package",dl:"video/dl",doc:"application/msword",drw:"application/drafting",dvi:"application/x-dvi",dwg:"application/acad",dxf:"application/dxf",dxr:"application/x-director",etx:"text/x-setext",ez:"application/andrew-inset",fli:"video/x-fli",flv:"video/x-flv",gif:"image/gif",gl:"video/gl",gtar:"application/x-gtar",gz:"application/x-gzip",hdf:"application/x-hdf",hqx:"application/mac-binhex40",html:"text/html",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ief:"image/ief",igs:"model/iges",ips:"application/x-ipscript",ipx:"application/x-ipix",jad:"text/vnd.sun.j2me.app-descriptor",jar:"application/java-archive",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",latex:"application/x-latex",lsp:"application/x-lisp",lzh:"application/octet-stream",m:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"application/x-troff-man",me:"application/x-troff-me",midi:"audio/midi",mif:"application/x-mif",mime:"www/mime",mkv:"  video/x-matrosk",movie:"video/x-sgi-movie",mp4:"video/mp4",mp41:"video/mp4",mp42:"video/mp4",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",mustache:"text/plain",nc:"application/x-netcdf",oda:"application/oda",ogm:"application/ogg",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pgp:"application/pgp",pm:"application/x-perl",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",ppz:"application/vnd.ms-powerpoint",pre:"application/x-freelance",prt:"application/pro_eng",ps:"application/postscript",qt:"video/quicktime",ra:"audio/x-realaudio",rar:"application/x-rar-compressed",ras:"image/x-cmu-raster",rgb:"image/x-rgb",rm:"audio/x-pn-realaudio",rpm:"audio/x-pn-realaudio-plugin",rtf:"text/rtf",rtx:"text/richtext",scm:"application/x-lotusscreencam",set:"application/set",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skt:"application/x-koan",smil:"application/smil",snd:"audio/basic",sol:"application/solids",spl:"application/x-futuresplash",src:"application/x-wais-source",stl:"application/SLA",stp:"application/STEP",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texinfo:"application/x-texinfo",tgz:"application/x-tar-gz",tiff:"image/tiff",tr:"application/x-troff",tsi:"audio/TSP-audio",tsp:"application/dsptype",tsv:"text/tab-separated-values",unv:"application/i-deas",ustar:"application/x-ustar",vcd:"application/x-cdlink",vda:"application/vda",vivo:"video/vnd.vivo",vrm:"x-world/x-vrml",wav:"audio/x-wav",wax:"audio/x-ms-wax",webm:"video/webm",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wvx:"video/x-ms-wvx",xbm:"image/x-xbitmap",xlw:"application/vnd.ms-excel",xml:"text/xml",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump",xyz:"chemical/x-pdb",zip:"application/zip"},mkdirRecurse=function(e){var i;if(!fs.existsSync(e))return i=path.dirname(e),fs.existsSync(i)||mkdirRecurse(i),fs.mkdirSync(e)},stylTree={downHash:{},upHash:{},parse:function(e){var i,a,t,o,n=[],p=path.dirname(e),r=fs.readFileSync(e).toString().split("\n").map(function(e){return/^ *@import (.+)/.exec(e)}).filter(function(e){return e}).map(function(e){return e[1]});for(r=r.map(function(e){return path.join(p,e.replace(/(\.styl)?$/,".styl"))}),i=0,a=(this.downHash[e]=r).length;i<a;++i)t=r[i],in$(e,(o=this.upHash)[t]||(o[t]=[]))||n.push(((o=this.upHash)[t]||(o[t]=[])).push(e));return n},findRoot:function(e){for(var i,a,t=[e],o=[];0<t.length;)i=t.pop(),0===((a=this.upHash)[i]||(a[i]=[])).length?o.push(i):t=t.concat(this.upHash[i]);return o}},ctype=function(e){return(e=/\.([^.]+)$/.exec(e=null==e?null:e))&&e[1]&&typeTable[e[1]]?typeTable[e[1]]:"application/octet-stream"},ftype=function(e){switch(!1){case!/\.ls$/.exec(e):return"ls";case!/\.styl/.exec(e):return"styl";case!/\.jade$/.exec(e):return"jade";default:return"other"}},routeTable={"/sample-cgi":sampleCgi=function(e,i){return i.writeHead(200,{"Content-type":"text/html"}),i.end("hello world!")}},server=function(e,i){var a,t,o,n,p,r,l;if(e.url=replace$.call(e.url,/[?#].*$/,""),(a=path.resolve(cwd,"."+e.url)).indexOf(cwd)<0)return i.writeHead(403,ctype()),i.end(e.url+" forbidden");if((l=a.replace(cwd,""))in routeTable)return routeTable[l](e,i);if(fs.existsSync(a)&&fs.lstatSync(a).isDirectory()&&(t=a.replace(/\/$/,""),!fs.existsSync(a+="/index.html"))){for(o=fs.readdirSync(t),t=e.url.replace(/\/$/,""),i.writeHead(200,{"Content-type":"text/html"}),i.write("<h2>"+t+"<h2>\n<ul>\n"),n=0,p=o.length;n<p;++n)r=o[n],i.write("<li><a href='"+t+"/"+r+"'>"+r+"</a></li>\n");return i.end("</ul>\n")}return fs.existsSync(a)?(console.log("[ GET ] "+a+" ("+ctype(a)+")"),l=fs.readFileSync(a),i.writeHead(200,{"Content-Length":l.length,"Content-Type":ctype(a)}),i.end(l)):(i.writeHead(404,ctype()),i.end(e.url+" not found"))},log=function(e,i,a){if(i=(i+"\n"+a).trim())return console.log(i)},filecache={},updateFile=function(e){var a,i,t,o,n,p,r,l,c,s;if(e&&!/node_modules|\.swp$/.exec(e)&&(a=(a="/"!==e[0]?path.join(cwd,e):e).replace(path.join(cwd,"/"),""),i=[ftype(a),"",""],t=i[2],"other"!==(i=i[0])))if("ls"===i)if(/src\/ls/.exec(a))try{o=(o=fs.readdirSync("src/ls/").map(function(e){return"src/ls/"+e})).filter(function(e){return null===/\/\./.exec(e)}),function(){for(var e,i=[],a=0,t=(e=o).length;a<t;++a)n=e[a],i.push(uglify.minify(lsc.compile(fs.readFileSync(n).toString(),{bare:!0}),{fromString:!0}).code);return i}().join("")}catch(e){p=e,console.log("[BUILD] "+a+" failed: "),console.log(p.message)}else{t=a.replace(/\.ls$/,".js");try{mkdirRecurse(path.dirname(t)),fs.writeFileSync(t,uglify.minify(lsc.compile(fs.readFileSync(a).toString(),{bare:!0}),{fromString:!0}).code),console.log("[BUILD] "+a+" --\x3e "+t)}catch(e){p=e,console.log("[BUILD] "+a+" failed: "),console.log(p.message)}}else{if("styl"===i){if(/(basic|vars)\.styl/.exec(e))return;try{stylTree.parse(a),r=stylTree.findRoot(a)}catch(e){p=e,console.log("[BUILD] "+a+" failed: "),console.log(p.message)}for(console.log("[BUILD] recursive from "+a+":"),l=0,c=r.length;l<c;++l){a=r[l];try{t=a.replace(/src\/styl/,"static/css").replace(/\.styl$/,".css"),stylus(fs.readFileSync(a).toString()).set("filename",a).define("index",d).render(m)}catch(e){p=e,console.log("[BUILD]   "+a+" failed: "),console.log(p.message)}}}if("jade"===i){t=a.replace(/\.jade$/,".html");try{s=path.dirname(t),fs.existsSync(s)&&fs.statSync(s).isDirectory()||mkdirRecurse(s),fs.writeFileSync(t,jade.render(fs.readFileSync(a).toString(),{filename:a,basedir:path.join(cwd)})),console.log("[BUILD] "+a+" --\x3e "+t)}catch(e){p=e,console.log("[BUILD] "+a+" failed: "),console.log(p.message)}}}function d(e,i){return e=(e.string||e.val).split(" "),new stylus.nodes.Unit(e.indexOf(i.val))}function m(e,i){return e?(console.log("[BUILD]   "+a+" failed: "),console.log("  >>>",e.name),console.log("  >>>",e.message)):(mkdirRecurse(path.dirname(t)),fs.writeFileSync(t,i),console.log("[BUILD]   "+a+" --\x3e "+t))}},watcher=chokidar.watch(watchPath=".",{ignored:ignoreFunc=function(i){return i?ignoreList.filter(function(e){return e.exec(i.replace(cwdRe,"").replace(/^\.\/+/,""))}).length:0},persistent:!0}).on("add",updateFile).on("change",updateFile),http.createServer(server).listen(9997,"0.0.0.0"),console.log("running server on 0.0.0.0:9997");